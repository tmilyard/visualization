<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <script src="http://d3js.org/d3.v3.min.js"></script>
    <style>
      circle {
        fill: orange;
        stroke: black;
        stroke-width: 0.7;
        opacity: 0.7;
      }

      h2 {
        text-align: center;
        color: black;
      }

      div.years_buttons {
        position: fixed;
        top: 5px;
        left: 50px;
      }

      div.years_buttons div {
        background-color: rgb(251, 201, 127);
        padding: 3px;
        margin: 7px;
      }

      .node {
          fill: #ccc;
          stroke: #fff;
          stroke-width: 1px;
      }

      .link {
          stroke: #777;
          stroke-width: 2px;
      }
    </style>
    <script type="text/javascript">  
      function draw(geo_data) {
        "use strict";
        var margin = 75,
            width = 1400 - margin,
            height = 600 - margin;

        d3.select("body")
          .append("h2")
          .text("World Cup ");

        var svg = d3.select("body")
            .append("svg")
            .attr("width", width + margin)
            .attr("height", height + margin)
            .append('g')
            .attr('class', 'map');

        var years = [];

          for(var i = 1930; i < 2015; i += 4) {
            if(i !== 1942 && i !== 1946) {
              years.push(i);
            };
          }

        var projection = d3.geo.mercator()
                               .scale(140)
                               .translate([width / 2, height / 1.2]);

        var path = d3.geo.path().projection(projection);

        var map = svg.selectAll('path')
                     .data(geo_data.features)
                     .enter()
                     .append('path')
                     .attr('d', path)
                     .style('fill', 'lightBlue')
                     .style('stroke', 'black')
                     .style('stroke-width', 0.5);

        // Import nodes.csv file and save it as nodes
        // nodes array = [{x: , y: } , ... ]
        // code_to_ind = {LAS: 0, IND: 1, ... }
        var nodes = [];
        var code_to_ind = {};
        d3.csv("nodes.csv", function(d) {
            d.forEach(function(i) {
                var a = {};
                a.x = +i.lon;
                a.y = +i.lat;
                nodes.push(a)

                code_to_ind[i['code']] = +i.ind;
            });
        });

        function plot_points(data) {
            
            function agg_day(leaves) {
                var source_coords = leaves.map(function(d) {
                    var var_tmp = [];
                    var_tmp.push(d.Dest);
                    var_tmp.push(projection([+d.Dest_lon, +d.Dest_lat]));
                    return var_tmp;
                });

                var target_coords = leaves.map(function(d) {
                    var var_tmp = [];
                    var_tmp.push(d.Origin);
                    var_tmp.push(projection([+d.Origin_lon, +d.Origin_lat]));
                    return var_tmp;
                });

                // target_nodes = [x: x coord, y: y coord, target: code]
                var target_nodes = [];

                // code_ind = {code0: 0, code1: 1, ... }
                var code_ind = {};

                // add the Dest into target_nodes and code_ind
                var a = {};
                a.x = source_coords[0][1][0];
                a.y = source_coords[0][1][1];
                a.target = source_coords[0][0];
                target_nodes.push(a);

                var ind = 1;

                target_coords.forEach(function(d) {
                    var a = {};
                    a.x = d[1][0];
                    a.y = d[1][1];
                    a.target = d[0];

                    target_nodes.push(a);

                    code_ind[d[0]] = ind;
                    ind++;
                });

                // nodes = [ {x: x coord, y: coord}, {x: x coord, y: coord}, ... ]
                var nodes = [];

                // links = [{target: 12, source: 0},{target: 12, source: 0}, ... ]
                var links = [];

                var start = 0;

                target_nodes.forEach(function(d) {
                    var a = {};
                    a.x = d.x;
                    a.y = d.y;
                    nodes.push(a);

                    var b = {};
                    b.source = 0;
                    if (start === 0) {
                        start = 1;
                    } else {
                        b.target = code_ind[d.target];
                        links.push(b);
                    }
                })

                return {
                  'nodes' : nodes,
                  'links' : links
                };
            }

            var nested = d3.nest()
                           .key(function(d) {
                              return d['id'];
                           })
                           // .rollup(agg_day)
                           .entries(data.sort(function(a, b) { 
                              if (b['id'] > a['id']) {
                                return -1;
                              } else {
                                return 1;
                              }
                           }));

            function key_func(d) {
                return d['key'];
            }

            // apply mercator function to nodes
            nodes = nodes.map(function(d) {
                var a = projection([+d.x, +d.y]);
                d.x = a[0];
                d.y = a[1];
                return d;
            })

            debugger;

            var links = [];

            data.forEach(function(d) {
                var a = {}
                a.target = code_to_ind[d.Dest];
                a.source = code_to_ind[d.Origin];
                links.push(a);
            })

            var force = d3.layout.force()
                          .size([width, height])
                          .nodes(nodes)
                          .links(links);

            debugger;

            // force.linkDistance(width/3.05);

            var link = svg.selectAll('.link')
                          .data(links)
                          .enter().append('line')
                          .attr('class', 'link');

            var node = svg.selectAll('.node')
                          .data(nodes)
                          .enter().append('circle')
                          .attr('class', 'node');

            force.on('end', function() {
                node.attr('r', 3)
                    .attr('cx', function(d) { return d.x; })
                    .attr('cy', function(d) { return d.y; });

                link.attr('x1', function(d) {return d.source.x; })
                    .attr('y1', function(d) {return d.source.y; })
                    .attr('x2', function(d) {return d.target.x; })
                    .attr('y2', function(d) {return d.target.y; });
                debugger;
            });

            force.start();

            debugger;
            // svg.append('g')
            //    .attr("class", "bubble")
            //    .selectAll("circle")
            //    .data(nested, key_func)
            //    .enter()
            //    .append("circle")
            //    .attr('cx', function(d) { return d.values['x']; })
            //    .attr('cy', function(d) { return d.values['y']; })
            //    .attr('r', function(d) {
            //         return radius(d.values['attendance']);
            //    })

          // function update(day) {
          //     var filtered = nested.filter(function(d) {
          //         return new d['day'] === day;
          //     });

          //     d3.select("h2")
          //       .text("January " + day + ", 2008");

          //     var circles = svg.selectAll('circle')
          //                      .data(filtered, key_func);

          //     circles.exit().remove();

          //     circles.enter()
          //            .append("circle")
          //            .transition()
          //            .duration(500)
          //            .attr('cx', function(d) { return d.values['x']; })
          //            .attr('cy', function(d) { return d.values['y']; })
          //            .attr('r', function(d) {
          //               return radius(d.values['attendance']);
          //            });

          //     var countries = filtered[0].values['teams'];

          //     function update_countries(d) {
          //         if(countries.indexOf(d.properties.name) !== -1) {
          //             return "lightBlue";
          //         } else {
          //             return 'white';
          //         }
          //     }

          //     svg.selectAll('path')
          //        .transition()
          //        .duration(500)
          //        .style('fill', update_countries)
          //        .style('stroke', update_countries);

          // }

          var year_idx = 0;

          // var year_interval = setInterval(function() {
          //   update(years[year_idx]);

          //   year_idx++;

          //   if(year_idx >= years.length) {
          //       clearInterval(year_interval);

          //       var buttons = d3.select("body")
          //               .append("div")
          //               .attr("class", "years_buttons")
          //               .selectAll("div")
          //               .data(years)
          //               .enter()
          //               .append("div")
          //               .text(function(d) {
          //                   return d;
          //               });

          //       buttons.on("click", function(d) {
          //           d3.select(".years_buttons")
          //             .selectAll("div")
          //             .transition()
          //             .duration(500)
          //             .style("color", "black")
          //             .style("background", "rgb(251, 201, 127)");

          //           d3.select(this)
          //             .transition()
          //             .duration(500)
          //             .style("background", "lightBlue")
          //             .style("color", "white");
          //           update(d);
          //       });
          //   }
          // }, 1000);
      }

      var format = d3.time.format("%d-%m-%Y (%H:%M h)");

      d3.csv("airport_filtered.csv", function(d) {
        if (d['day'].length === 1) {
            d['id'] = "0" + d['day']+"-"+d['Dest'];  
        } else {
            d['id'] = d['day']+"-"+d['Dest'];  
        }
        d['Dest_lon'] = +d['Dest_lon']
        d['Dest_lat'] = +d['Dest_lat']
        d['Origin_lon'] = +d['Origin_lon']
        d['Origin_lat'] = +d['Origin_lat']
        d['day'] = +d['day']
        return d;
      }, plot_points);
    };
    </script>
  </head>
<body>
  <script type="text/javascript">
  /*
    Use D3 to load the GeoJSON file
    */
    
d3.json("world_countries.json", draw);
  </script>
</body>
</html>
